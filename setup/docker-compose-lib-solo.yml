version: '3.3'
networks:
    internal:
services:
    rclone_media_scanner:
        # container_name: pdp-rclone-secure_media_scanner
        command: 'mount --read-only --log-level INFO --stats 300s --dir-cache-time 30m --poll-interval 10m --multi-thread-streams=20  secure_media: /mnt/secure_media --allow-non-empty --allow-other'
        restart: always
        labels:
            - "autoheal=true"
        environment:
            - TZ=Australia/Melbourne
            - PGID=100
            - PUID=99
            - 'HEALTHCHECK_MOUNTS=/mnt/secure_media'
            - 'HEALTHCHECK_PATHS=/mnt/secure_media'
        volumes:
            - '${DOCKER_ROOT}/mnt/rclone/secure_media_scanner/:/mnt/secure_media:rshared'
            - '${DOCKER_ROOT}/rclone/:/config/rclone:rshared'
            - '${DOCKER_ROOT}/scripts/:/scripts:ro'
        networks:
            - internal
        logging:
            options:
                max-size: 20m
        devices:
            - /dev/fuse
        cap_add:
            - SYS_ADMIN
        security_opt:
            - apparmor:unconfined     
        image: rclone/rclone
        healthcheck:
            test: ["CMD-SHELL", "sh /scripts/healthcheck"]
            interval: 300s
            timeout: 60s
            retries: 3
            start_period: 30s
    plex_scanner:
        # container_name: pdp-plex-scanner
        networks:
            - internal
        restart: always
        labels:
            - "autoheal=true"
        environment:
            - TZ=Australia/Melbourne
            - PLEX_CLAIM=claim-xxxxxxxxxxxxxxx
            - PLEX_UID=99
            - PLEX_GID=100
            - VERSION=latest
            - 'NVIDIA_VISIBLE_DEVICES='
            - PUID=99
            - PGID=100
            - 'PLEXDRIVE_MEDIA_FOLDERS='
            - 'RCLONE_MEDIA_PATH=/mnt/rclone/secure_media_scanner/Media'
            - 'HEALTHCHECK_MOUNTS=/mnt/rclone/secure_media_scanner'
            - 'HEALTHCHECK_PATHS=/plex/media/Media/tv-4k'
        volumes:
            - '${DOCKER_ROOT}/mnt/rclone/secure_media_scanner/:/mnt/rclone/secure_media_scanner:rshared'
            - '${DOCKER_ROOT}/plex-scanner/:/config:rw'
            - '${DOCKER_ROOT}/scripts/:/scripts:ro'
        ports:
            - "34400:32400"
        image: linuxserver/plex
        healthcheck:
            test: ["CMD-SHELL", "bash /scripts/plexhealthcheck"]
            interval: 300s
            timeout: 60s
            retries: 3
            start_period: 30s
        # depends_on:
            # rclone_media_scanner:
                # condition: service_healthy